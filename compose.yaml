services:
  # +---------------------------------------------------------------------------+
  # | WARNING: This config may lead to copyright issues. Use at your own risk!  |
  # | Ensure compliance with copyright laws before proceeding.                  |
  # +---------------------------------------------------------------------------+

  # *****************************************************************************
  # docker-servarr-seedbox
  #
  # Author: Steve Theisen (steve@tyzen9.com)
  #         https://www.github.com/tyzen9
  #
  # If there is a service below you do not plan to use, then simply comment its
  # it's section out by placing a '#' symbol before each line of the ENTIRE 
  # section. 
  #
  # This Docker Stack expects a properly configured ".env" file.  Please make a 
  # copy of the "sample.env" file called ".env" and configure it properly for 
  # your before starting this stack.  See comments in "sample.env"
  #
  #          !! Use caution when making changes below the WARNING below !!
  #
  # *****************************************************************************
  
  # *****************************************************************************
  # pia-vpn
  #    This AWESOME PIA wireguard VPN is created and maintained by thrnz
  #    For details on this container, and the available options be sure to 
  #    check out: https://github.com/thrnz/docker-wireguard-pia
  #
  #    This VPN will secure ALL traffic for this stack, you can see this in 
  #    these configuration tags:
  #
  #        network_mode: "service:vpn"
  #        depends_on:
  #          - vpn
  #
  #   Action: This should be considered required, visit PIA to get started
  #           https://www.privateinternetaccess.com/buy-vpn-online
  # *****************************************************************************
  vpn:
    image: thrnz/docker-wireguard-pia:${TAG_PIA:-latest}
    container_name: pia-vpn
    restart: always
    volumes:
      - pia-token:/pia
      - pia-portnumber:/pia-shared
      - /etc/localtime:/etc/localtime:ro               
      - /etc/timezone:/etc/timezone:ro                 
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      # The following env vars are required:
      - LOC=${PIA_LOC}
      - USER=${PIA_USERNAME}
      - PASS=${PIA_PASSWORD}
      # The rest are optional:
      - LOCAL_NETWORK=${LOCAL_NETWORK}
      - KEEPALIVE=${KEEPALIVE:-25}
      - PORT_FORWARDING=${PORT_FORWARDING:-1}
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      # May as well disable ipv6. Should be blocked anyway.
      - net.ipv6.conf.default.disable_ipv6=1
      - net.ipv6.conf.all.disable_ipv6=1
      - net.ipv6.conf.lo.disable_ipv6=1
    # Since other services will use this network, we need to open the port for qbittorrent
    ports:
      - ${QBT_WEB_PORT:-8080}:8080
      - ${PROWLARR_WEB_PORT:-9696}:9696
      - ${SONARR_WEB_PORT:-8989}:8989
      - ${RADARR_WEB_PORT:-7878}:7878
      - ${READARR_WEB_PORT:-8787}:8787
      - ${FLARESOLVER_WEB_PORT:-8191}:8191
      - ${BAZARR_WEB_PORT:-6767}:6767

    # The container has no recovery logic. Use a healthcheck to catch disconnects.
    healthcheck:
      test: ping -c 1 www.google.com || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=latest'
      - 'wud.watch.digest=true'           
      - 'wud.link.template=https://hub.docker.com/r/thrnz/docker-wireguard-pia' 

  # *****************************************************************************
  # prowlarr
  #    Prowlarr is an indexer manager and proxy that helps integrate various 
  #    PVR (Personal Video Recorder) applications by managing both Torrent 
  #    Trackers and Usenet Indexers. It works suggested that this be used 
  #    with all Sonarr services to consolidate indexer configurations
  #
  #  Action: if you plan to use an *arr service, then you probably want
  #          Prowlarr so you can centralize all indexer configuration in
  #          one place.
  # *****************************************************************************
  prowlarr:
    image: linuxserver/prowlarr:${TAG_PROWLARR:-latest}
    container_name: prowlarr
    restart: always
    environment:
      - TZ=${TZ_ID}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    volumes:
      - prowlarr-config:/config
    network_mode: "service:vpn"
    depends_on:
      vpn:
        condition: service_healthy
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/Prowlarr/Prowlarr/releases'
      # Offen Backup Labels -------------------------------------------------
      - "docker-volume-backup.stop-during-backup=${BACKUP_LABEL}"

  # *****************************************************************************
  # sonarr - TV show searching.
  # 
  #   Action: if you are not using this, then comment it out
  # *****************************************************************************
  sonarr:
    image: linuxserver/sonarr:${TAG_SONARR:-latest}
    container_name: sonarr
    restart: unless-stopped
    environment:
      - TZ=${TZ_ID}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    volumes:
      - sonarr-config:/config
      - ${TV_VOLUME}:/tv
      - ${DOWNLOADS_VOLUME}:/downloads
    network_mode: "service:vpn"
    depends_on:
      - vpn
      - prowlarr
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/Sonarr/Sonarr/releases'
      # Offen Backup Labels -------------------------------------------------
      - "docker-volume-backup.stop-during-backup=${BACKUP_LABEL}"

  # *****************************************************************************
  # radarr - Movie searching.
  # 
  #   Action: if you are not using this, then comment it out
  # *****************************************************************************
  radarr:
    image: linuxserver/radarr:${TAG_RADARR:-latest}
    container_name: radarr
    restart: unless-stopped
    environment:
      - TZ=${TZ_ID}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    volumes:
      - radarr-config:/config
      - ${MOVIE_VOLUME}:/movies
      - ${DOWNLOADS_VOLUME}:/downloads
    network_mode: "service:vpn"
    depends_on:
      - vpn
      - prowlarr
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/Radarr/Radarr/releases'
      # Offen Backup Labels -------------------------------------------------
      - "docker-volume-backup.stop-during-backup=${BACKUP_LABEL}"

  # *****************************************************************************
  # bazarr - Movie subtitles.
  # 
  #   Action: if you are not using this, then comment it out
  # *****************************************************************************
  bazarr:
    image: linuxserver/bazarr:${TAG_BAZARR:-latest}
    container_name: bazarr
    restart: unless-stopped
    environment:
      - TZ=${TZ_ID}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    volumes:
      - bazarr-config:/config
      - ${MOVIE_VOLUME}:/movies
      - ${TV_VOLUME}:/tv
    network_mode: "service:vpn"
    depends_on:
      - vpn
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/Radarr/Radarr/releases'
      # Offen Backup Labels -------------------------------------------------
      - "docker-volume-backup.stop-during-backup=${BACKUP_LABEL}"

  # *****************************************************************************
  # recyclarr - Automatically sync TRaSH guides to your Sonarr and Radarr instances.
  # 
  #   Action: if you are not using this, then comment it out
  # *****************************************************************************
  recyclarr:
    image: ghcr.io/recyclarr/recyclarr:${TAG_RECYCLARR:-latest}
    container_name: recyclarr
    restart: unless-stopped
    environment:
      - TZ=${TZ_ID}
      - CRON_SCHEDULE=0 4 * * *   # Runs daily at 4:00 AM (change time as needed, e.g., 30 3 for 3:30 AM)
    user: ${PUID:-1000}:${PGID:-1000}
    volumes:
      - recyclarr-config:/config
    network_mode: "service:vpn"
    depends_on:
      - vpn
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/recyclarr/recyclarr/releases'
      # Offen Backup Labels -------------------------------------------------
      - "docker-volume-backup.stop-during-backup=${BACKUP_LABEL}"
          
  # *****************************************************************************
  # overseerr - Overseerr is a free and open source software application for managing 
  # requests for your media library. It integrates with your existing services, 
  # such as Sonarr, Radarr, and Plex
  # 
  #   Action: if you are not using this, then comment it out
  # *****************************************************************************
  overseerr:
    image: linuxserver/overseerr:${TAG_OVERSEERR:-latest}
    container_name: overseerr
    restart: unless-stopped
    environment:
      - TZ=${TZ_ID}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    volumes:
      - overseerr-config:/config
    ports:
      - 5055:5055
    depends_on:
      - sonarr
      - radarr
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/sct/overseerr/releases'
      # Offen Backup Labels -------------------------------------------------
      - "docker-volume-backup.stop-during-backup=${BACKUP_LABEL}"

  # *****************************************************************************
  # qbittorrent
  #    qBittorrent is based on the Qt toolkit and libtorrent-rasterbar 
  #    library. 
  #
  #   See: https://docs.linuxserver.io/images/docker-qbittorrent/
  #
  #   Action: If you will ONLY be using a cloud based seedbox then you can
  #           comment this out. However, local seedboxes can be nice for
  #           occasional public tracker usage and can be configured separately
  #           from other seedboxes in *arr apps
  #
  # *****************************************************************************
  qbittorrent:
    image: linuxserver/qbittorrent:${TAG_QBT:-latest}
    container_name: qbittorrent
    restart: always
    environment:
      - TZ=${TZ_ID}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - WEBUI_PORT=${QBT_WEB_PORT:-8080}
    volumes:
      - qbittorrent-config:/config
      - ${DOWNLOADS_VOLUME}:/downloads
    network_mode: "service:vpn"
    depends_on:
      vpn:
          condition: service_healthy
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=^[0-9]\.\d+\.\d+$$'  # Match a single digit first
      - 'wud.link.template=https://www.qbittorrent.org/news'
      # Offen Backup Labels -------------------------------------------------
      - "docker-volume-backup.stop-during-backup=${BACKUP_LABEL}"

  # *****************************************************************************
  # qbittorrent-port-helper (Steve Theisen)
  #    Looks for a file named "port.dat", reads the port number in that
  #    file and uses that to update the Listening Port number used by
  #    qBittorrent. The PIA image above is configured to drop the "port.dat"
  #    file into the pia-portnumber volume.
  #
  #   See: https://github.com/tyzen9/docker-qbittorrent-port-helper 
  #
  #   Action: If you are not using qBittorrent locally you can comment this
  #           out. If you are not using PIA, then another VPN client will 
  #           need to be configured to drop its port-forward number into a
  #           "port.dat" in a shared volume this can use
  # *****************************************************************************
  qbittorrent-port-helper:
    image: tyzen9/qbittorrent-port-helper:${TAG_QBT_HELPER:-latest}
    container_name: qbittorrent-port-helper
    restart: always
    init: true
    volumes:
      - pia-portnumber:/vpn-data
    environment:
      - TZ=${TZ_ID}
      - QBITTORRENT_USERNAME=${QBITTORRENT_USERNAME}
      - QBITTORRENT_PASSWORD=${QBITTORRENT_PASSWORD}
      - QBITTORRENT_PORT_NUMBER=${QBITTORRENT_PORT_NUMBER:-8080}
      - QBITTORRENT_URL=${QBITTORRENT_URL}
    network_mode: "service:vpn"
    depends_on:
      - qbittorrent
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/tyzen9/docker-qbittorrent-port-helper/releases'            

  # *******************************************************************
  # Stripparr  (Mike Nye)
  #    Removes unwanted metadata from downloaded media, and is created 
  #    and maintained by Mike Nye and other contributors
  #
  #   See:  https://github.com/mikenye/docker-striparr
  #
  #   Action: You will need to configure Sonarr/Radarr to use Striparr:
  #           https://github.com/mikenye/docker-striparr#sonarrradarr-configuration 
  # *******************************************************************
  striparr:
    image: mikenye/striparr:${TAG_STRIPARR:-latest}
    container_name: striparr
    restart: always
    environment:
      - TZ=${TZ_ID}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    volumes:
      - ${MOVIE_VOLUME}:/movies
      - ${TV_VOLUME}:/tv
    network_mode: "service:vpn"
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=latest'
      - 'wud.watch.digest=true'           
      - 'wud.link.template=https://github.com/mikenye/docker-striparr/releases' 

  # *******************************************************************
  # flaresolverr 
  #    FlareSolverr is a proxy server to bypass Cloudflare and 
  #    DDoS-GUARD protection. Depending on the indexers you use, you 
  #    may need to configure this.  
  #
  #   See: https://github.com/FlareSolverr/FlareSolverr
  #
  #   Action: Configure the indexers in Prowlarr as shown in this link:
  #           https://trash-guides.info/Prowlarr/prowlarr-setup-flaresolverr/ 
  # *******************************************************************
  flaresolverr:
    image: flaresolverr/flaresolverr:${TAG_FLARESOLVER:-latest}
    container_name: flaresolverr
    restart: always
    environment:
      - TZ=${TZ_ID}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_HTML=${LOG_HTML:-false}
      - CAPTCHA_SOLVER=${CAPTCHA_SOLVER:-none}
    volumes:
      - flaresolverr-config:/config
    network_mode: "service:vpn"
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=^v\d+\.\d+\.\d+$$'  # Support leading 'V'
      - 'wud.link.template=https://github.com/FlareSolverr/FlareSolverr/releases'            

  # *******************************************************************
  # unpackerr
  #     Unpackerr monitors and extracts downloaded archives for 
  #     applications like Sonarr, Radarr, Lidarr, etc.
  #     It helps automate post-processing by unzipping files into 
  #     your media library after downloads complete.
  #
  #     See: https://github.com/Unpackerr/unpackerr
  #
  #     Action: Configure each app connection (Sonarr, Radarr, etc.)
  #             in the Unpackerr settings to match your download and
  #             media directory paths.
  # *******************************************************************
  unpackerr:
    image: golift/unpackerr:${TAG_UNPACKERR:-latest}
    container_name: unpackerr
    restart: always
    user: ${PUID:-1000}:${PGID:-1000}
    environment:
      - TZ=${TZ_ID}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - UN_LOG_FILE=/downloads/logs/unpackerr.log
      - UN_SONARR_0_URL=${SONARR_URL:-http://localhost}:${SONARR_WEB_PORT:-8989}
      - UN_SONARR_0_API_KEY=${SONARR_API_KEY}
      - UN_RADARR_0_URL=${RADARR_URL:-http://localhost}:${RADARR_WEB_PORT:-7878}
      - UN_RADARR_0_API_KEY=${RADARR_API_KEY}
    network_mode: "service:vpn"
    volumes:
      - ${DOWNLOADS_VOLUME}:/downloads
    depends_on:
      vpn:
        condition: service_healthy
      sonarr:
        condition: service_started
      radarr:
        condition: service_started
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/Unpackerr/unpackerr/releases'            


  # *****************************************************************************
  # lftp-mirror (Steve Theisen)
  #    This is container is used to pull downloaded files from a remote seedbox
  #    using lftp.  This will mirror the content between the two directories.
  #
  #  See: https://github.com/tyzen9/docker-lftp-mirror
  #
  #  Action: If you do not use a remote seedbox, you can comment this service out
  # *****************************************************************************
  lftp-mirror:
    image: tyzen9/lftp-mirror:${TAG_LFTP_MIRROR:-latest}
    container_name: lftp-mirror
    restart: always
    init: true
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}            
      - SOURCE_HOSTNAME=${SOURCE_HOSTNAME}
      - SSH_USERNAME=${SSH_USERNAME}
      - SSH_PASSWORD=${SSH_PASSWORD}
      - SOURCE_DIR=${SOURCE_DIR}
      - SOURCE_EXCLUDES=${SOURCE_EXCLUDES}
    volumes:
      - ${DOWNLOADS_VOLUME}:/downloads
      - /etc/localtime:/etc/localtime:ro               
      - /etc/timezone:/etc/timezone:ro                 
    network_mode: "service:vpn"
    depends_on:
      vpn:
        condition: service_healthy
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -----
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/tyzen9/docker-lftp-mirror/releases'  
  
  # *********************************************************************************
  # volume-backup
  #   Automated daily backup of Docker named volumes using offen/docker-volume-backup.
  #   This lightweight service runs in the background, creates a single compressed 
  #   archive containing all specified volumes, and automatically prunes old backups 
  #   based on the configured retention period. It ensures data consistency by 
  #   temporarily stopping labeled containers during the backup process. Backups 
  #   are stored locally on the host; a separate secure process (e.g., rsync/cron) 
  #   can be used for off-site transfer.
  #
  # *********************************************************************************
  volume-backup:
    image: offen/docker-volume-backup:${TAG_OFFEN:-latest}
    container_name: ${BACKUP_LABEL}-backup
    restart: unless-stopped
    environment:
      - BACKUP_CRON_EXPRESSION=${BACKUP_CRON_EXPRESSION:-0 2 * * *}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-14}
      - BACKUP_FILENAME=${BACKUP_LABEL}-%Y-%m-%dT%H-%M-%S.tar.gz
      - BACKUP_STOP_DURING_BACKUP_LABEL=${BACKUP_LABEL}
      - NOTIFICATION_LEVEL=${BACKUP_NOTIFICATION_LEVEL:-error}
      - NOTIFICATION_URLS=${BACKUP_NOTIFICATION_URLS}          # Comma-separated list of URLs      
    volumes:
      # Volumes to backup
      # - overseerr-config:/backup/overseerr-config:ro                     
      - prowlarr-config:/backup/prowlarr-config:ro                     
      - qbittorrent-config:/backup/qbittorrent-config:ro                     
      - recyclarr-config:/backup/recyclarr-config:ro                     
      - radarr-config:/backup/radarr-config:ro                     
      - bazarr-config:/backup/bazarr-config:ro                     
      - sonarr-config:/backup/sonarr-config:ro                     
      - readarr-config:/backup/readarr-config:ro                     
      # Local backup location - use a separate secure transfer process to move backups to another host
      - ${BACKUP_LOCAL_TMP_PATH}:/tmp  # Assign a specific tmp dir on the host.  Comment this out to use /tmp
      - ${BACKUP_LOCAL_PATH}:/archive                     
      # Time synch with host to ensure accurate CRON scheduling
      - /etc/localtime:/etc/localtime:ro               
      - /etc/timezone:/etc/timezone:ro                 
      # Allows backup container to control other containers
      - /var/run/docker.sock:/var/run/docker.sock:ro   

    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -------------
      # Support leading 'V'
      - 'wud.tag.include=^v\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/offen/docker-volume-backup/releases'  
  
  # # *****************************************************************************
  # # readarr - Audiobook and eBook searching.  
  # #
  # #   Warning: Currently readarr has no active devs, and the servarr team 
  # #            would like someone to take over readarr development. It still
  # #            works, but not as well as it once did.
  # # 
  # #   Action: if you are not using this, then comment it out
  # # *****************************************************************************
  # readarr:
  #   # Readarr is currently releasing from their "develop" branch
  #   image: lscr.io/linuxserver/readarr:${TAG_READARR:-latest}
  #   container_name: readarr
  #   restart: unless-stopped
  #   environment:
  #     - TZ=${TZ_ID}
  #     - PUID=${PUID:-1000}
  #     - PGID=${PGID:-1000}
  #   volumes:
  #     - readarr-config:/config
  #     - ${BOOKS_VOLUME}:/books
  #     - ${DOWNLOADS_VOLUME}:/downloads
  #   network_mode: "service:vpn"
  #   depends_on:
  #     - vpn
  #     - prowlarr

volumes:
  flaresolverr-config:
  overseerr-config:
  pia-token:
  pia-portnumber:
  prowlarr-config:
  qbittorrent-config:
  readarr-config:
  recyclarr-config:
  radarr-config:
  bazarr-config:
  sonarr-config:
